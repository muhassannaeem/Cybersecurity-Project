input {
  beats {
    port => 5044
  }
}

filter {
  # Parse JSON logs if they're already in JSON format
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "parsed"
    }
    
    # Move parsed fields to root level
    if [parsed] {
      ruby {
        code => "
          if event.get('parsed').is_a?(Hash)
            event.get('parsed').each do |key, value|
              event.set(key, value) unless key == 'message'
            end
          end
        "
      }
      mutate {
        remove_field => ["parsed"]
      }
    }
  }
  
  # Parse timestamp
  if [@timestamp] {
    date {
      match => [ "@timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd'T'HH:mm:ss.SSSZ" ]
      target => "@timestamp"
    }
  } else {
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd'T'HH:mm:ss.SSSZ" ]
      target => "@timestamp"
    }
  }
  
  # Add service name from container labels or host
  if [container] {
    mutate {
      add_field => { "service" => "%{[container][name]}" }
    }
  } else if [host][name] {
    mutate {
      add_field => { "service" => "%{[host][name]}" }
    }
  }
  
  # Categorize log types based on event_type or service
  if [event_type] {
    mutate {
      add_field => { "log_type" => "%{event_type}" }
    }
  } else if [service] =~ /backend/ {
    mutate {
      add_field => { "log_type" => "system" }
    }
  } else if [service] =~ /(threat|attribution)/ {
    mutate {
      add_field => { "log_type" => "threat" }
    }
  } else if [service] =~ /(decoy|honeypot)/ {
    mutate {
      add_field => { "log_type" => "attack" }
    }
  } else {
    mutate {
      add_field => { "log_type" => "system" }
    }
  }
  
  # Extract IP addresses
  if [ip_address] {
    mutate {
      add_field => { "source.ip" => "%{ip_address}" }
    }
  }
  
  # Extract user information
  if [user_id] {
    mutate {
      add_field => { "user.id" => "%{user_id}" }
    }
  }
  
  # Add index name based on log type
  if [log_type] == "threat" {
    mutate {
      add_field => { "[@metadata][index]" => "cybersecurity-threats" }
    }
  } else if [log_type] == "attack" {
    mutate {
      add_field => { "[@metadata][index]" => "cybersecurity-attacks" }
    }
  } else if [log_type] == "audit" {
    mutate {
      add_field => { "[@metadata][index]" => "cybersecurity-audit" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][index]" => "cybersecurity-system" }
    }
  }
  
  # Add environment tag
  mutate {
    add_field => { "environment" => "development" }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index]}-%{+YYYY.MM.dd}"
    template_name => "cybersecurity-logs"
    template => "/usr/share/logstash/templates/cybersecurity-template.json"
    template_overwrite => true
  }
  
  # Debug output (can be removed in production)
  if [level] == "DEBUG" {
    stdout {
      codec => rubydebug
    }
  }
}

